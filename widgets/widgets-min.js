Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){function n(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}if(null===this)throw new TypeError('"this" is null or not defined');var o=Object(this),a=o.length>>>0;if(0===a)return!1;for(var i=0|t,l=Math.max(i>=0?i:a-Math.abs(i),0);a>l;){if(n(o[l],e))return!0;l++}return!1}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){return(void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e}}),String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),t+e.length>this.length?!1:-1!==this.indexOf(e,t)});var PREF=function(){function e(e,t,n){function o(e){var o=a[e],i=o.category,l=o.name,r=o.sketches,c=o.pages;if(i&&i[0]!==n&&"all"!==i[0]){if("none"===i[0])return"none"}else if("all"===l[0]||l.includes(t)){if(!r||r.includes(s)||r.includes(d)||"all"===r[0]){if("string"==typeof c){c=c.split(",");for(var u=0;u<c.length;u++)c[u]=c[u].trim()}return c}if("none"===r[0])return"none"}else if("none"===l[0])return"none"}var i,l,r=e.focusPage.anchorNode,s=r.context.id,c=r.data("url")||r.data("delayed-url")||"",d=c.match(/([\w\d_-]*)\.?[^\\\/]*$/i)[1];n||(n=""),n=n.toLowerCase(),t=t.toLowerCase(),l=e.getAuthorPreference(t+n);for(var u=0;u<a.length;u++)i=o(u),"none"===i?l=void 0:i&&(l=i);return l}function t(e,t,n){var o,a;if(!e)return[t];for(a=e.toLowerCase().split(","),o=0;o<a.length;o+=1)a[o]=a[o].trim();if(1===a.length&&["all","none"].includes(a[0]))return a;if(n)for(o=0;o<a.length;o+=1)a[o]=parseInt(a[o],10);return a}function n(e,n,o,a){try{this.category=t(e,"all"),"all"===this.category[0]&&(this.category=["widget, util"]),this.name=t(n,"all"),this.pages=t(a,"all",!0),this.sketches=t(o,"all")}catch(e){throw GSP.createError("bad arguments to WSPPref constructor")}}function o(e){var t,o;if(e.constructor===Array)for(var i=0;i<e.length;i++){var l=e[i];t=l.category?l.category:"widget, util",o=l.name?l.name:"all",l.widget&&(t="widget",o=l.widget),a.push(new n(t,o,l.sketches,l.pages))}}var a=[];return{setWebPagePrefs:function(e){o(e)},shouldEnableForCurrentPage:function(t,n,o){var a=parseInt(o.metadata.id,10),i=e(o.document,n,t);return i===!0||Array.isArray(i)&&("all"===i[0]||i.includes(a))},getPref:function(t,n,o){return e(t,n,o)}}}(),WIDGETS=function(){function e(e,t){return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t.prototype}function t(e,n){if(!e||!n||"object"!=typeof e||"object"!=typeof n)return e===n;if(Object.keys(e).length!==Object.keys(n).length)return!1;for(var o in e)if(!t(e[o],n[o]))return!1}function n(){return pe?he.data("document").sQuery.sketch:void 0}function o(e){return $(e).closest(".sketch_canvas")[0]}function a(e,t){this.name=e,this.eventName=t,this.domButtonSelector="#widget_"+e+"ButtonID",this.enabled=!0}function i(e,t){a.call(this,e,t)}function l(e){arguments.length&&!e?r():(ue.tinyDraggable({exclude:".dragExclude"}),ue.toggle(!0),$(".widget_button").removeClass("widget_button_active"),he.parent().find(".widget_button").addClass("widget_button_active"))}function r(){ue&&ue.toggle(!1),$(".widget_button").removeClass("widget_button_active")}function s(){var e,t=$(".sketch_canvas");Te.objectColorBox=$("#objectColorCheckbox")[0],Te.textColorBox=$("#textColorCheckbox")[0],t.on("LoadDocument.WSP",function(e,t){v(t.document.canvasNode[0]),w(t.document)}),t.on("UnloadDocument.WSP",function(e,t){me&&n()===t.document.focusPage&&me.deactivate()}),t.on("WillUndoRedo.WSP",y),t.on("UndoRedo.WSP",m),t.on("WillChangeCurrentPage.WSP",y),t.on("DidChangeCurrentPage.WSP",m),t.each(function(t,n){var o=$(n).data("document");v(n),o&&(w(o),e||(e=o))}),e&&m({},{document:e}),t.on("keyup",function(e){return 27===e.keyCode&&me?(me.deactivate(),!0):void 0})}function c(){var e=$(".wCharDropdownContent .column div");$._data(e[0],"events")||$(".wCharDropdownContent .column div").click(function(){ee(this.innerText)})}function d(e,t){var a=o(e),i=$(a),s=i.find(".wsp-tool-column"),d=i.data("document"),u=d.sQuery.sketch,f=$(e.parentNode).find(".widget_button"),p=PREF.getPref(d,"showWidgetPanelOnPageStart");if("none"===i.css("display")||u===ge)return me;var h=!1;return je.forEach(function(e){e.checkEnablingForCurrentPage(u)&&(h=!0)}),h?(me&&(ye=me,me.deactivate()),je.forEach(function(e){e.setEnablingForCurrentPage(u,e)}),(a!==pe||t)&&(pe&&(he.off("WillPlayTool.WSP"),he.off("ToolPlayed.WSP"),he.off("ToolAborted.WSP")),pe=a,he=$(pe),ge=u,fe.detach(),i.prepend(fe),c(),l(),ue.css({top:i.height()-ue.height()+1}),ue.css(s.length?{left:s[0].offsetWidth-ue[0].offsetWidth+4}:{left:-1}),he.on("WillPlayTool.WSP",function(){$("#widget").css({opacity:.25,"z-index":-1}),me&&(ye=me,WIDGETS.confirmModality())}),he.on("ToolPlayed.WSP",function(){$("#widget").css({opacity:1,"z-index":"none"}),ye&&(ye.activate(n()),ye=null)}),he.on("ToolAborted.WSP",function(){$("#widget").css({opacity:1,"z-index":"none"})}),Oe.setVisColor(u),l(p)),f.show(),p&&ye&&ye.enabled&&ye.activate(u,ye),ye=null,h&&me):(pe&&a!==pe||(ye||(ye=me),me&&me.deactivate(),r(),f.hide()),!1)}function u(e){n()!==e&&d(e.canvasNode[0]),n()===e&&me&&me.preProcessGobj&&(e.sQuery("*").each(function(e,t){me.preProcessGobj(t)}),e.isDirty=!0,e.setNeedsDisplay())}function f(e,t){var o=t?t.sketch:n();return u(o),!0}function p(){return me&&me.postProcessSketch&&me.postProcessSketch(n()),!0}function h(){return parseFloat(getComputedStyle($("#widget")[0]).fontSize)/16}function g(e,t){e.checked=t,e.src=t?de+"checked.png":de+"unchecked.png"}function b(e){return e.checked=e.checked?!1:!0,e.src=e.checked?de+"checked.png":de+"unchecked.png",e.checked}function m(e,t){var n=t.document;d(n.canvasNode[0],!0)}function y(){me&&(ye=me,me.deactivate())}function v(e){var t,n=e.parentNode,o=$(n).find(".widget_button");1===o.length&&(t='<button class="widget_button" onclick="WIDGETS.toggleWidgets(this);">Widgets</button>',o.replaceWith(t))}function w(e){var t,n,o,a;t=e.canvasNode,n=t.parent(),n.hasClass("sketch_container")&&(o=t.find(".wsp-base-node"),a=n.find(".wsp-base-node").width(),a&&(a+=parseInt(n.css("border-left-width"),10)+parseInt(n.css("border-right-width"),10)),n.outerWidth(a))}function S(e){be&&be&&be!==e&&(be.setRenderState("none"),be=null),e&&(be=e,be.setRenderState(ve))}function P(e,t){var n=he.find("[wsp-id='"+t.id+"']").not(".wsp-sr-only");n[0]&&(n.css({color:e}),n.find("*").css({color:e}))}function k(e,t){var n=!1,o=t||be;if(!o)return!1;if(o.isOfKind("Text"))n=o.style.color!==e,n&&(o.style.color=e);else if(o.isOfKind("Button"))n=o.style.label.color!==e,n&&(o.style.label.color=e);else if(o.style.label&&o.style.label.showLabel&&(n=o.style.label.color!==e))return o.style.label.color=e,o.sQuery.sketch.renderRefCon.label[o.id].color=e,!0;return n&&P(e,o),K(o),n}function C(){var e,t,n=be;if(n.oldStyle)if(n.isOfKind("Button")||n.isOfKind("Text"))e=n.isOfKind("Text")?n.oldStyle.color:n.oldStyle.label.color,t=n.isOfKind("Text")?n.style.color:n.style.label.color;else if(n.style.label&&n.style.label.showLabel)return n.sQuery.sketch.renderRefCon.label[n.id].color=n.style.label.color,void n.invalidateAppearance();e&&t!==e&&k(e)}function L(){var e,t=Math.floor(ke/3);switch(ke-3*t){case 0:e="a";break;case 1:e="b";break;case 2:e="c"}return $(".block"+t+e).css("background-color")}function T(e,t){var n=!1,o=t||be;return o&&Te.objectColorBox.checked&&(o.isOfKind("Text")?n=k(e,o):(o.setRenderState("none"),n=o.style.color!==e,n&&(o.style.color=e,o.invalidateAppearance()),o.setRenderState(ve))),n}function O(e){var t=be;we=e,t&&t.style.radius&&we>=0&&(t.setRenderState("none"),t.style.radius=$e[we],t.setRenderState(ve),t.invalidateAppearance())}function E(e,t){var n=be;Pe=e,Se=t,n&&(n.setRenderState("none"),n.isOfGenus("Path")&&Pe>=0&&(n.style["line-style"]=Ce[Pe]),n.style.width&&Se>=0&&(n.style.width=Le[Se]),n.setRenderState(ve),n.invalidateAppearance())}function x(e){var t=L(e);Te.objectColorBox.checked&&T(t),Te.textColorBox.checked&&k(t)}function F(e,t){var n=$("#lineStyleCheckbox")[0],o=$("#widget_lineStyleSelector")[0].style;if(0>e&&0>t)g(n,!1),o.display="none";else{Te.defaultLineThickness=e,Te.defaultLineStyle=t,g(n,!0);var a=1.25*e+1.31,i=3.2*t+.31;o.top=a+"rem",o.left=i+"rem",o.display="block"}E(t,e)}function j(e){var t=$("#pointStyleCheckbox")[0],n=$("#pointStyleSelector")[0].style;if(0>e)g(t,!1),n.display="none";else{Te.defaultPointStyle=e,g(t,!0);var o=1.25*e+1.31;n.top=o+"rem",n.display="block"}O(e)}function B(e,t){var n=$("#widget_colorSelector")[0].style;0>e?(n.display="none",g(Te.objectColorBox,!1),g(Te.textColorBox,!1),ke=-1):(ke=3*e+t,n.top=1.56*t+.13+"rem",n.left=1.69*e+.1+"rem",n.display="block",Te.defaultColor={row:t,column:e},Te.textColorBox.checked||g(Te.objectColorBox,!0),be&&x(ke))}function R(e){var t=e.style;t.originalColor=t.color,t.label&&t.label.color&&(t.label.originalColor=t.label.color)}function W(e){var t=e.style;if(t.faded)throw GSP.createError("visibilityWidget deleteFadeCache() called for a faded object.");t.originalColor&&(delete t.originalColor,t.label&&t.label.color&&delete t.label.originalColor,delete t.faded)}function _(e){var t=e.style;if(t.faded)throw GSP.createError("visibilityWidget fade() called for an already-faded object.");e.style.originalColor||R(e),t.faded||(t.color=Oe.visColor,t.label&&t.label.color&&(t.label.color=Oe.visColor),P(t.color,e),t.faded=!0,e.invalidateAppearance())}function G(e){var t=e.style;if(!t.originalColor||!t.faded)throw GSP.createError("visibilityWidget unfade() called for an object that isn't faded.");t.color=t.originalColor,t.label&&t.label.color&&(t.label.color=t.label.originalColor),P(t.color,e),t.faded=!1,e.invalidateAppearance()}function N(){n().labelPool.saveState(),Ee.labelPoolSaved=!0}function M(){Ee.labelPoolSaved&&(n().labelPool.restoreSavedState(),Ee.labelPoolSaved=!1)}function D(){Ee.labelPoolSaved&&(be.sQuery.sketch.labelPool.forgetSavedState(),Ee.labelPoolSaved=!1)}function A(e){var t=Ee.inputElt;"string"==typeof e&&t.val(e),t.focus(),t[0].setSelectionRange(0,t.val().length)}function I(e){var t;N(),t=n().labelPool.generateLabel(e.kind,e.genus),e.hasLabel?e.setLabel(t,{showLabel:!0,wasUserInitiated:!0}):e.label=t,A(t)}function U(e){var t=e.sQuery.sketch,n=Y(e),o=n["font-family"];return"number"==typeof o&&(o>=t.document.resources.fontList.length&&(o=0),o=t.document.resources.fontList[o],n["font-family"]=o),o}function z(e){var t="";return e.genus.includes("Measure")?t="measure":e.genus.includes("Parameter")?t="param":e.useTransformLabel&&e.useTransformLabel()&&(t="transImage"),t}function K(e){var t,n,o=he.find("[wsp-id='"+e.id+"']"),a=Y(e)["font-family"],i=Y(e)["font-size"],l=Y(e).color,r=e.sQuery.sketch,s=r.renderRefCon,c=e.hasLabel?s.label[e.id]:s.gobj[e.id];e.parsedMFS=null,e.hasLabel?(H(c,"invalidateLabel passed a labeled gobj with no renderRefCon.label"),c["font-family"]=a,c["font-size"]=i,n=s.labelBounds[e.id],n&&r.invalidateRect(n),e.state.labelPreRenderJITPrepareDone=!1,e.labelPreRenderJITPrepare(r.dcForGObjLabel(e,"normal"),r.renderRefCon.label[e.id])):(t=c.css,c=c.baseStyles,H(1===o.length,"invalidateLabel should find a single matching node."),t["font-family"]=a,t["font-size"]=i,t.color=l,c["font-family"]=a,c["font-size"]=i,c.color=l,o.css({"font-size":i,"font-family":a}),$(o).find('[style*="font-family"]').css("font-family",a),e.state.forceDomParse=!0,e.descendantLabelGraphHasChanged(),Ee.showLabelElt.prop("checked","noVisibleName"!==e.style.nameOrigin)),e.invalidateAppearance()}function V(e,t){function n(){H(!t,"A button or function shouldn't have a nameOrigin."),a.shouldAutogenerateLabel&&(a.shouldAutogenerateLabel=!1),i&&(e=" ",A(e)),a.label=e,a.messages&&(a.messages=[])}function o(){a.label=e,e=e.replace(/'/g,"\\'"),a.textMFS="<VL<T'"+e+"'>>"}var a=be,i=!e||""===e,l=void 0===a.style.nameOrigin||t===a.style.nameOrigin;return e||(e=""),be.label===e&&l?e:(i&&M(),t&&(a.style.nameOrigin=t),a.hasLabel?(a.shouldAutogenerateLabel=["namedByPrime","namedByShortFn","namedByFullFn","namedFromTemplate"].includes(t),i&&(e=a.label),a.setLabel(e,{showLabel:i?!1:!0}),Ee.showLabelElt[0].checked=i?!1:!0,e=a.label):a.isOfKind("Button")||a.isOfGenus("Function")?n():"Caption"===a.genus?o():"namedFromLabel"===t&&(i?(I(a),e=a.label):a.label=e),K(a),e)}function Q(){$("#wLabelPrompt").css("display","none"),$("#wLabelPane").css("display","block")}function H(e,t){e||t||(t="Unidentified error")}function J(e){var t=be,n={},o=Ee.touchPos,a=t.style.label,i=a&&a.showLabel;t.hasLabel&&!t.label&&I(t),void 0===e&&(t.hasLabel?e=!a.showLabel:Ee.nameClass&&t.style.nameOrigin&&(e="noVisibleName"!==t.style.nameOrigin)),t.hasLabel?(a.showLabel=e,e&&!i&&(t.isAPath()&&(t.labelRenderBounds||(t.labelRenderBounds=X(t.sQuery.sketch.renderRefCon.labelBounds[t.id])),Ee.isTap&&(n.x=o.x-t.labelRenderBounds.left,n.y=o.y-t.labelRenderBounds.top)),Ee.isTap&&(n=a.labelOffsetX?{x:-a.labelOffsetX+o.x-t.labelSpec.location.x,y:-a.labelOffsetY+o.y-t.labelSpec.location.y}:{x:a["font-size"],y:+a["font-size"]/2},t.setLabelPosition(o,n)),""===Ee.inputElt[0].innerText&&A(t.label))):Ee.nameClass&&t.style.nameOrigin&&LabelControls.labelChanged(e?t.label:""),Ee.showLabelElt.prop("checked",e),K(t)}function X(e,t){return t||(t={}),t.top=e.top,t.bottom=e.bottom,t.left=e.left,t.right=e.right,t}function Y(e){var t=e.style.label;return(!t||$.isEmptyObject(t))&&(t=e.style),t}function q(e){var t,n=U(e);return t=n.substring(0,1),'"'===t||"'"===t?n=n.split(t)[1]:n.indexOf(",")&&(n=n.split(",")[0]),n}function Z(){var e,t,n,o=$.makeArray($("script[src]"));for(e=0;e<o.length;e++)if(t=o[e],t.src&&t.src.endsWith("/widgets.js"))return n=t.src.split("?")[0].split("/").slice(0,-1).join("/")+"/"}function ee(e){var t="",n="",o=Ee.inputElt[0],a=o.selectionStart,i=o.selectionEnd,l=o.value;a>0&&(t=l.slice(0,a)),i<l.length&&(n=l.slice(i)),l=t+e+n,WIDGETS.labelChanged(l),o.value=l,i=t.length+e.length,o.focus(),o.setSelectionRange(i,i)}function te(e){return!(e.isOfKind("Text")||e.isOfKind("AngleMarker")||e.isOfKind("PathMarker")||e.isOfKind("Button")||e.isOfKind("CoordSys")||e.isOfKind("DOMKind")||e.isOfKind("IterateImage")||e.isOfKind("Map")||e.isOfKind("Picture"))}function ne(){var e,t,n=ge.MotionManager.motionList;for(e=0;e<n.length;e++)if(t=ge.MotionManager.motionSet[n[e]],t&&"active"===t.state)return!1;return!0}function oe(e){n().sQuery("*").each(function(t,n){n.style.traced&&!n.style.hidden&&n.setRenderState(e)})}function ae(){!xe.glowBox.checked||!ne()&&$("#wTraceEnabled")[0].checked?ie("force"):oe("unmatchedGiven")}function ie(e){var t=$("#wTraceEnabled")[0].checked,n="force"===e;(t||n)&&oe("none")}function le(){he.on("StartDrag.WSP",ie),he.on("EndDrag.WSP",ae),he.on("StartAnimate.WSP",ie),he.on("EndAnimate.WSP",ae),he.on("StartMove.WSP",ie),he.on("EndMove.WSP",ae)}function re(){he.off("StartDrag.WSP"),he.off("EndDrag.WSP"),he.off("StartAnimate.WSP"),he.off("EndAnimate.WSP"),he.off("StartMove.WSP"),he.off("EndMove.WSP")}function se(e,t){$.each(e,function(e,n){n.setRenderState(t)})}function ce(e){function t(e){n[e.id]&&alert("addGobj in deleteWidget called for an already-listed gobj!"),n[e.id]=e,e.setRenderState("targetHighlit"),e.children.forEach(function(e){n[e.id]||t(e)})}var n={};t(e),Fe.progenyList=n}var de,ue,fe,pe,he,ge,be,me,ye,ve="fadeInOut",we=-1,Se=-1,Pe=-1,ke=-1,$e=[1.5,2,4,6],Ce=["solid","dashed","dotted"],Le=[.5,1,3,5];a.prototype.activate=function(e,t){return me&&me!==t&&me.deactivate(),e.document.isCurrentlyInToolplay()?!1:(me=t,this.active=!0,this.sketch=e,$(t.domButtonSelector).addClass("widget_active"),$(".widgetPane").on("keyup",function(e){27===e.keyCode&&me.deactivate()}),!0)},a.prototype.deactivate=function(e){e===me&&(me=null),this.active=!1,this.sketch=null,$(e.domButtonSelector).removeClass("widget_active"),$(".widgetPane").off("keyup")},a.prototype.toggle=function(e,t){this===me?this.deactivate(t):this.activate(e,t)},a.prototype.checkEnablingForCurrentPage=function(e){var t;return t=PREF.shouldEnableForCurrentPage("widget",this.name,e),"trace"===this.name&&(t=t&&e.preferences.tracesEnabled),t},a.prototype.setEnablingForCurrentPage=function(e,t){var n=this.checkEnablingForCurrentPage(e);return t.enabled=n,n?$(t.domButtonSelector).show():(this===me&&t.deactivate(),ue.find(t.domButtonSelector).hide()),n},e(i,a),i.prototype.preProcessGobj=function(e){},i.prototype.postProcessGobj=function(e){},i.prototype.activate=function(e,t){var n=$(".sketch_canvas"),o=e.hasTouchRegimes()&&e.currentTouchRegime();return Object.getPrototypeOf(this).activate(e,t)?(n=$(".sketch_canvas"),n.on("Tap.WSP",t.handleTap),o&&"DisplayRegime"===o.name&&o.allowUnselectableTap(!0),u(e),!0):!1},i.prototype.deactivate=function(e){var t=n(),o=$(".sketch_canvas"),a=t.hasTouchRegimes()&&t.currentTouchRegime();o.off("Tap.WSP",e.handleTap),o.off("WillUndoRedo.WSP",p),o.off("UndoRedo.WSP",f),me&&me.postProcessSketch&&me.postProcessSketch(this.sketch),a&&"DisplayRegime"===a.name&&a.allowUnselectableTap(!1),Object.getPrototypeOf(this).deactivate(e)},i.prototype.handleTap=function(e,t){var n=o(t.document.canvasNode[0]);return n===pe||d(n)?t.gobj:null};var Te=new i("style","ChangeStyle");Te.cancelOnExit=!1,Te.defaultColor={row:0,column:1},Te.defaultPointStyle=2,Te.defaultLineThickness=2,Te.defaultLineStyle=0;var Oe=new i("visibility","ChangeVisibility"),Ee=new i("label","ChangeLabel");Ee.labelPoolSaved=!1,Ee.touchPos=GSP.GeometricPoint(0,0),Ee.textRule=null;var xe=new i("trace","ChangeTraceStatus"),Fe=new i("delete","DeleteGObjs"),je=[Te,xe,Ee,Oe,Fe];return i.prototype.postProcessSketch=function(e){var t=[];return me&&me.postProcessGobj&&(e.sQuery("*").each(function(e,n){me.postProcessGobj(n)&&t.push(n)}),t.length&&this.sketch.event(me.eventName,{gobjArr:t},{}),e.isDirty=!0),!0},Te.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,$("#wStylePane").css("display","block"),!0):!1},Te.deactivate=function(){Object.getPrototypeOf(this).deactivate(this),$("#wStylePane").css("display","none"),this.cancelOnExit=!1,S(null)},Te.postProcessGobj=function(e){var n=!1,o=Te.cancelOnExit;return e.oldStyle&&(o?(e.style=jQuery.extend(!0,{},e.oldStyle),C(),e.sQuery.sketch.invalidateAppearance(e)):n=!t(e.oldStyle,e.style),delete e.oldStyle),Object.getPrototypeOf(Te).postProcessGobj(e),n},Te.handleTap=function(e,t){var n;n=Object.getPrototypeOf(Te).handleTap(e,t),n&&(S(n),n.oldStyle||(n.oldStyle=jQuery.extend(!0,{},n.style)),O(we),E(Pe,Se),ke>=0&&x(ke))},Oe.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?($("#wVisibilityPrompt").css("display","block"),!0):!1},Oe.deactivate=function(){$("#wVisibilityPrompt").css("display","none"),Object.getPrototypeOf(this).deactivate(this)},Oe.preProcessGobj=function(e){"byUser"===e.style.hidden&&(e.show(),e.sQuery.sketch.constrainAndRedraw(),_(e),e.wasHidden=!0),Object.getPrototypeOf(Oe).preProcessGobj(e)},Oe.postProcessGobj=function(e){var t,n,o=e.style;return o.faded&&(e.hide("byUser"),G(e),t=!0),W(e),n=e.style.hidden&&!e.wasHidden||!e.style.hidden&&e.wasHidden,Object.getPrototypeOf(Oe).postProcessGobj(e),e.wasHidden&&delete e.wasHidden,n},Oe.handleTap=function(e,t){var n=Object.getPrototypeOf(Oe).handleTap(e,t);n&&(n.style.faded?G(n):_(n),$("#wVisibilityPrompt").css("display","none"))},Oe.setVisColor=function(e){var t="rgb(192,192,192)",n=e.preferences.colorableComponents.Background.color;if(n){var o=document.createElement("div");o.style.color=n;var a=window.getComputedStyle(o).color;if("rgb"===a.substring(0,3)){var i=a.split("(")[1].split(")")[0];i=i.split(","),t="rgb(";for(var l=0;3>l;l++)t+=i[l]<128?i[l]+64:i[l]-32,2>l&&(t+=",");t+=")"}}Oe.visColor=t},Ee.cacheProperties=function(e){this.oldLabel="Caption"===e.genus?e.textMFS:e.label,this.oldAutoGenerate=e.shouldAutogenerateLabel,U(e),this.oldStyle=$.extend(!0,{},e.style)},Ee.emptyCache=function(){this.oldLabel=null,this.oldStyle=null},Ee.clear=function(e){this.emptyCache(),D(),A(""),$("#measureButtons, #transImageButtons, #paramButtons").toggle(!1),e!==!1&&(Ee.sizeElt.val(""),Ee.fontElt.val(""),Ee.showLabelElt.prop("checked",!1))},Ee.finalizeLabel=function(){function e(e){var n="Caption"===e.genus?e.textMFS:e.label,a=n!==o.oldLabel||o.oldAutoGenerate!==e.shouldAutogenerateLabel||!t(o.oldStyle,e.style);a&&o.sketch.event(o.eventName,{gobj:e},{})}var n,o=this;be&&(e(be),be.hasLabel&&be.style.nameOrigin&&(n=LabelControls.originFromText(be.label),n&&be.style.nameOrigin!==n&&(be.style.nameOrigin=n)),delete this.oldLabel,delete this.oldAutoGenerate,delete this.oldStyle)},Ee.restoreLabel=function(e){e&&(e.style&&(e.style=$.extend(!0,{},Ee.oldStyle)),"Caption"===e.genus?(e.textMFS=Ee.oldLabel,delete e.label):Ee.oldLabel?(e.label=Ee.oldLabel?"":" ",V(Ee.oldLabel,e.style.nameOrigin),e.shouldAutogenerateLabel=Ee.oldAutoGenerate):(delete e.label,e.shouldAutogenerateLabel=Ee.oldAutoGenerate),M(),K(e)),this.emptyCache()},Ee.handleTap=function(e,t){function n(){function e(){function e(){function e(e){var t={init:!0};return(r.style.nameOrigin===e||!l.label&&"namedFromLabel"!==r.style.nameOrigin)&&(t.create=!0),r.makeParentalLabel(e,t)}var t,n,o,l;(r.isTransformationConstraint||r.state.labelParent)&&(l=r.isTransformationConstraint?r.parents.source:r.state.labelParent,t=e("namedByPrime"),n=e("namedByShortFn"),o=e("namedByFullFn")),i[t]="namedByPrime",i[n]="namedByShortFn",i[o]="namedByFullFn",i["*"]=r.label?"namedFromLabel":"namedByPrime",a.namedByPrime=t,a.namedByShortFn=n,a.namedByFullFn=o,a.namedFromLabel=r.label?r.label:t,r.label?r.style.nameOrigin=i[r.label]||"namedFromLabel":(r.label=t,r.style.nameOrigin="namedByPrime")}function t(){a={namedFromTemplate:"",noVisibleName:"",namedFromLabel:"*"},i={" ":"noVisibleName","*":"namedFromLabel"}}var n,o=Ee.nameClass,a={},i={};if(n=f&&z(d)===o?d:r,$(".wLabelRadios").toggle(!1),o){switch($("#"+o+"Buttons").toggle(!0),o){case"transImage":e(),Ee.handleTap&&n&&z(n)===o&&"namedFromLabel"!==n.style.nameOrigin&&(r.style.nameOrigin=n.style.nameOrigin);break;case"measure":case"param":t()}LabelControls.init(o,be,WIDGETS.controlCallback,a,i,"#wLabelEditText","#"+o+"Buttons input[type='radio']","#wLabelShow")}else LabelControls.terminate()}function t(){var e=s.val();e&&Ee.setFontSize(e),e=c.val(),e&&Ee.setFont(e)}function n(e){var t,n=!1;for(t=0;t<c[0].length;t++)if(c[0][t].innerText===e){c[0].selectedIndex=t,n=!0;break}return n}function o(e,t){var n,o,a,i=$("#wLabelFont optgroup"),l="<option value='"+e+"'>"+t+"</option>",r=i.filter('[label="Sans Serif"]'),s=i.filter('[label="Serif"]'),d=i.filter('[label="Mono-spaced"]'),u=i.filter('[label="Other"]'),f=!1;for(o=e.search(/sans-serif/i)?r:e.search(/serif/i)?s:e.search(/monospace/i)?d:u.length?u:c.append('<optgroup label="Other"></optgroup>'),a=$(o).find("option"),n=0;n<a.length;n++)if(-1===t.localeCompare(a[n].innerText)){$(a[n]).before($(l)),f=!0;break}f||o.append(l)}function a(){var e=Y(be),t=e["font-size"];if(s.val(t),c[0].selectedIndex=-1,t=q(be,!1),!t)throw GSP.createError("WIDGETS.copyGObjToStyles() found a gobj without a font family.");n(t)||(o(e["font-family"],t),n(t))}function i(e,t){var n;return n=e&&t&&e.hasLabel===t.hasLabel,n=n&&(t.hasLabel||e.kind===t.kind||e.isOfKind("Measure")&&t.isOfKind("Measure")),n=n&&(Ee.isTap||!t.hasLabel||!t.style.label.showLabel)}function l(){var e,t=u.textMFS,n=t.match(/<T\'[^\'\r\n]+\'>/g),o="";for(e=0;e<n.length;e++)o&&(o+=" "),o+=n[e].replace(/<T\'([^\'\r\n]+)\'>/,"$1");return o}var r,d,f,p;p=!1,"Caption"!==u.genus||u.label?"CompositeText"===u.genus&&(p=!0):u.label=l(),$("#wLabelEditText").prop("disabled",p),$("#wLabelEditLabel").prop("disabled",p),u.hasLabel||u.style.nameOrigin?$("#wShowLabelButton label").show():$("#wShowLabelButton label").hide(),r=u,d=be,f=i(d,r),Ee.clear(!1),be&&be.setRenderState("none"),u.setRenderState("targetHighlit"),this.prevGobj=be,be=u,Ee.nameClass=z(be),Ee.cacheProperties(be),r.hasLabel&&!r.style.label.showLabel&&(r.labelRenderBounds=X(r.sQuery.sketch.renderRefCon.labelBounds[r.id])),A(be.label),f?t():a(),e()}function o(){r.prop("disabled",!1),J(!0),r.prop("checked",!0)}function a(){var e=be.style.nameOrigin,t=be.isOfKind("Button"),n="measure"===Ee.nameClass||"param"===Ee.nameClass,o=t||"undefined"==typeof e,a=o||"namedFromLabel"===e;t?(r.prop("checked",a),r.prop("disabled",o)):n&&($("#wLabelPane .radio-inline input").prop("checked",!1),$("#wLabelPane .radio-inline input[value='"+e+"']").prop("checked",!0),r.prop("checked","noVisibleName"!==e),r.prop("disabled",!1))}function i(e){var t=e.match(/<VL<T\'.*\'>>/);return t||(t=e.match(/<T\'.*\'>/)),t?!0:!1}var l=Ee.inputElt,r=Ee.showLabelElt,s=Ee.sizeElt,c=Ee.fontElt,d=GSP.GeometricPoint(t.position.x,t.position.y),u=Object.getPrototypeOf(Ee).handleTap(e,t);if(Ee.touchPos=d,Ee.isTap=!0,u.canEditLabel()&&("Caption"!==u.genus||i(u.textMFS))){if(Q(),u===be)return be.hasLabel&&(J(),A(be.label)),void(Ee.isTap=!1);Ee.finalizeLabel(),n(),be.hasLabel?o():a(),l.on("keyup",function(e){if(e.stopPropagation(),13===e.keyCode)Ee.deactivate();else if(27===e.keyCode)Ee.cancelOnExit=!0,Ee.deactivate();else{var t=l.val();t.length>0?V(t):be.isOfKind("Button")&&A(" ")}}),Ee.isTap=!1}},Ee.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,be=null,this.prevGobj=null,$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","block"),this.inputElt||(this.inputElt=$("#wLabelEditText"),this.showLabelElt=$("#wLabelShow"),this.sizeElt=$("#wLabelFontSize"),this.fontElt=$("#wLabelFont")),this.inputElt.on("click",function(){$(this).focus()}),this.clear(),!0):!1},Ee.deactivate=function(){be&&(be.setRenderState("none"),this.cancelOnExit?this.restoreLabel(be):this.confirmLabel()),this.clear(),Object.getPrototypeOf(this).deactivate(this),$("#wLabelContent").css("display","none"),$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","none"),this.cancelOnExit=!1},Ee.confirmLabel=function(){this.finalizeLabel(),this.clear()},Ee.setFontSize=function(e){var t=Y(be);e=+e,t["font-size"]!==e&&(t["font-size"]=e,K(be))},Ee.setFont=function(e){var t=Y(be),n=t["font-family"];n!==e&&(t["font-family"]=e,K(be))},Ee.postProcessSketch=function(e){Ee.clear(),$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","block"),be=null,Object.getPrototypeOf(Ee).postProcessSketch(e)},xe.setGlowing=function(){xe.glowBox.checked?(le(),ae()):(re(),ie("force"))},xe.toggleEnabling=function(e){var t=void 0!==e?e:$("#wTraceEnabled")[0].checked;n().preferences.tracesEnabled=t,$("#wTraceEnabled").prop("checked",t),$("#wTracePrompt").css("display","none"),ae()},xe.toggleFading=function(){var e=n(),t=e.preferences,o=$("#wTraceFading")[0].checked;t.fadeTraces=o,o?(e.traces.fadeStartTime=Date.now(),e.startFadeJob()):e.stopFadeJob(),$("#wTracePrompt").css("display","none")},xe.activate=function(e){return xe.glowBox=$("#wTracesGlowing")[0],Object.getPrototypeOf(this).activate(e,this)?($("#wTracePrompt").css("display","block"),$("#wTraceEnabled").prop("checked",n().preferences.tracesEnabled),$("#wTraceFading").prop("checked",n().preferences.fadeTraces),this.cancelOnExit=!1,$("#wTracePane").css("display","block"),xe.setGlowing(),xe.autoEnabled=!1,!0):!1},xe.deactivate=function(){xe.glowBox.checked&&ie("force"),Object.getPrototypeOf(this).deactivate(this),$("#wTracePane").css("display","none"),this.cancelOnExit=!1},xe.signalChangedTraceState=function(e){function t(){var e=n().canvasNode.css("backgroundColor"),t=e.match(/rgba\(.*,.*,.*,\s*(.*)\)/);return t&&t[1]&&"0"===t[1]?"white":e}var o=e.state.renderState,a=e.style.color;e.style.traced?(e.setRenderState("targetHighlit"),setTimeout(function(){e.setRenderState(o)},500)):e.isOfKind("Point")?(e.hide(),setTimeout(function(){e.show()},500)):(e.style.color=t(),e.style.width&&(e.style.width+=1),e.invalidateAppearance(),setTimeout(function(){e.style.color=a,e.style.width&&(e.style.width-=1),e.invalidateAppearance()},500))},xe.handleTap=function(e,t){var n,o,a=Object.getPrototypeOf(xe).handleTap(e,t);te(a)&&a&&(n=a.style,n.traced=!n.traced,o="tracing "+(n.traced?"on":"off"),xe.sketch.event(xe.eventName,{gobj:a},{"new status":o}),n.traced?(xe.autoEnabled||(xe.toggleEnabling(!0),xe.autoEnabled=!0),xe.glowBox.checked&&a.setRenderState("unmatchedGiven")):a.setRenderState("none"),$("#wTracePrompt").css("display","none"),xe.glowBox.checked||xe.signalChangedTraceState(a))},Fe.deleteProgeny=function(){var e,t=this.sketch,n=t.document.getRecentChangesDelta();t.gobjList.removeGObjects(Fe.progenyList,t),e=t.document.pushConfirmedSketchOpDelta(n),t.document.changedUIMode(),this.sketch.event(this.eventName,{"deleted gobjs":Fe.progenyList},{delta:e})},Fe.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,$("#wDeletePrompt").css("display","block"),!0):!1},Fe.deactivate=function(){Object.getPrototypeOf(this).deactivate(this),$("#wDeletePrompt").css("display","none"),this.cancelOnExit=!1},Fe.handleTap=function(e,t){var n=Object.getPrototypeOf(Fe).handleTap(e,t),o=$("#delete-confirm-modal"),a=o.find(".util-popup-content");n&&(ce(n),o.css("display","block"),a.tinyDraggable({exclude:".dragExclude"}),$("#deleteCancel").focus())},Fe.deleteConfirm=function(){$("#delete-confirm-modal").css("display","none"),Fe.deleteProgeny(),delete Fe.progenyList},Fe.deleteCancel=function(){$("#delete-confirm-modal").css("display","none"),se(Fe.progenyList,"none"),delete Fe.progenyList},{initWidget:function(){de=Z(),$.ajax({url:de+"widgets.html",success:function(e){$("#widget")&&$("#widget").remove(),$("body").append(e),fe=$("<div style='position: relative; height:0; width:100%;'></div>"),$("body").append(fe),ue=$("#widget"),ue.detach(),fe.append(ue),ue.css("display","none"),s(),$("#widget img").attr("src",function(e,t){var n=t.match(/[^\/]+$/);return de+n})},dataType:"html"})},showWidgets:function(e,t){if(!ue)throw GSP.createError("showWidgets called before loading $widget.");return e?(t&&d(t),void((pe||!e)&&(e?(l(),ye&&(ye.activate(n(),ye),ye=null)):(me&&(ye=me,me.deactivate()),r())))):void r()},relatedSketchNode:function(e,t){for(var n=$(e),o=n.filter(t);n.length&&!o.length;)o=n.prevAll(t),n=n.parent();if(!o.length)throw GSP.createError("relatedSketchNode() couldn't find the target: "+t);return o[0]},toggleWidgets:function(e){var t="none"===ue.css("display"),n=WIDGETS.relatedSketchNode(e,".sketch_canvas");if(!n)throw GSP.createError("toggleWidgets called for an element that's neither a sketch_canvas nor a widget_button");return n!==pe&&(t=!0),WIDGETS.showWidgets(t,n),t},confirmModality:function(){me&&(me.cancelOnExit=!1,me.deactivate())},cancelModality:function(){me&&(me.cancelOnExit=!0,me.deactivate())},toggleStyleModality:function(){me===Te?Te.deactivate(this):Te.activate(n(),Te)},toggleVisibilityModality:function(){me===Oe?Oe.deactivate(Oe):pe&&he.data("document")&&Oe.activate(n(),Oe)},toggleLabelModality:function(){me===Ee?Ee.deactivate(Ee):pe&&he.data("document")&&Ee.activate(n(),Ee)},toggleObjectModality:function(){me===Fe?Fe.deactivate(Fe):pe&&he.data("document")&&Fe.activate(n(),Fe)},toggleTraceModality:function(){me===xe?xe.deactivate(xe):pe&&he.data("document")&&xe.activate(n(),xe)},setTraceGlowing:function(){xe.setGlowing(),$("#wTracePrompt").css("display","none")},toggleTraceFading:function(){xe.toggleFading()},toggleTraceEnabling:function(){xe.toggleEnabling()},clearTraces:function(){n().clearTraces(),$("#wTracePrompt").css("display","none")},pointCheckClicked:function(){j(0>we?Te.defaultPointStyle:-1)},pointGridClicked:function(e){var t=h();j(Math.floor(e.offsetY/(20*t)))},lineCheckClicked:function(){0>Pe&&0>Se?F(Te.defaultLineThickness,Te.defaultLineStyle):F(-1,-1)},lineGridClicked:function(e){var t=h();F(Math.floor(e.offsetY/(20*t)),Math.floor(e.offsetX/(51*t)))},colorCheckClicked:function(){var e=b(Te.objectColorBox);e||Te.textColorBox.checked?0>ke&&B(Te.defaultColor.column,Te.defaultColor.row):B(-1,0)},labelCheckClicked:function(){var e=b(Te.textColorBox);e||Te.objectColorBox.checked?0>ke&&B(Te.defaultColor.column,Te.defaultColor.row):B(-1,0)},labelSetFontSize:function(e){
be&&Ee.setFontSize(+e)},labelSetFont:function(e){be&&Ee.setFont(e)},colorGridClicked:function(e){var t=h(),n=e.pageX-$("#widget_colorGrid").offset().left,o=e.pageY-$("#widget_colorGrid").offset().top,a=Math.min(8,Math.floor(n/(27.2*t))),i=Math.floor(o/(27*t));B(a,i)},labelChanged:function(e){LabelControls.labelChanged(e)||V(e)},controlCallback:function(e,t){return e=V(e,t)},labelToggled:function(){J(Ee.showLabelElt.prop("checked"))},deleteConfirm:function(){Fe.deleteConfirm(this)},deleteCancel:function(){Fe.deleteCancel(this)},setWidgetsPrefs:function(e){PREF.setWebPagePrefs(e)},getScriptPath:function(){return de},resizeSketchFrame:function(e){w(e)}}}(),LabelControls=function(){function e(e,t){var n={namedFromTemplate:o,namedFromLabel:a,noVisibleName:i},c={namedByPrime:l,namedByShortFn:r,namedByFullFn:s,namedFromLabel:a,noVisibleName:i};switch(e){case"measure":case"param":return n[t];case"transImage":return c[t]}}function t(t,n,o,a,i,l,r,s){this.mode=t,this.oldText=n.label,this.oldOrigin=n.style.nameOrigin,this.lastOrigin="",this.labelText=n.label,$(l).prop("value",n.label),this.callback=o,this.textRule=a,this.originRule=i,this.radioSelector=r,this.inputSelector=l,this.showSelector=s,this.tappedGobj=n,this.radioPressed=function(t){var n,o,a=this.textRule[t],i=this.tappedGobj;"namedFromLabel"===t&&""===a&&(a=i.label),(t!==i.style.nameOrigin||a!==i.label)&&(n=e(this.mode,t),this.state=new n(this)),"namedFromLabel"===t&&(o=$(this.inputSelector)[0],o.focus(),o.setSelectionRange(0,o.value.length))},this.originFromText=function(e){var t;return""===e?t="noVisibleName":(t=this.originRule[e],t||(t="transImage"===this.mode?"namedFromLabel":this.originRule["*"])),t},this.labelChanged=function(t,n){var o=e(this.mode,n);this.labelText=t,this.state instanceof o?this.callback(t,n):this.state=new o(this)},this.state=null}function n(e){this.nameOrigin=e,this.init=function(t,n,o){var a,i=n,l="noVisibleName"===e&&"transImage"===t.mode;this.machine=t,e!==t.lastOrigin&&(i=t.callback(n,e)),""!==n&&$(t.inputSelector).val(i),a=$(this.machine.radioSelector+"[value="+e+"]"),a.prop("checked")||a.prop("checked",!0),l?$(t.radioSelector).prop("checked",!1):i!==n&&(this.machine.labelText=i,delete this.machine.originRule[n],this.machine.originRule[i]=e,this.machine.textRule[e]=i),$(t.showSelector).prop("checked",o),t.lastOrigin=e}}function o(e){this.init(e,"",!0)}function a(e){this.init(e,e.labelText,!0)}function i(e){this.init(e,"",!1),WIDGETS.labelToggled()}function l(e){this.init(e,e.textRule.namedByPrime,!0)}function r(e){this.init(e,e.textRule.namedByShortFn,!0)}function s(e){this.init(e,e.textRule.namedByFullFn,!0)}var c;return o.prototype=new n("namedFromTemplate"),o.prototype.constructor=o,a.prototype=new n("namedFromLabel"),a.prototype.constructor=a,i.prototype=new n("noVisibleName"),i.prototype.constructor=i,l.prototype=new n("namedByPrime"),l.prototype.constructor=l,r.prototype=new n("namedByShortFn"),r.prototype.constructor=r,s.prototype=new n("namedByFullFn"),s.prototype.constructor=s,{init:function(n,o,a,i,l,r,s,d){var u=e(n,o.style.nameOrigin);c=new t(n,o,a,i,l,r,s,d),c.state=new u(c),$(".wLabelRadios label").click(function(e){LabelControls.transition(e)})},terminate:function(){c&&(c=null)},transition:function(e){var t=e.target.value||e.target.children[0].value;t&&c.radioPressed(t)},labelChanged:function(e){return c?(c.labelChanged(e,this.originFromText(e)),!0):!1},originFromText:function(e){return c?c.originFromText(e):null}}}(),PAGENUM=function(){function e(e,t){return $(e).parent().find(t)}function t(e){return $(e).data("document")}function n(e){function t(e){if(!Number.isInteger(e))throw GSP.createError("bad argument to setToolEnabling enableThisPage.");o.addClass("p_"+e)}var n,o,a,i,l=e.canvasNode[0],r=$(l).find("div.wsp-tool");for(n=0;n<r.length;n++)o=$(r[n]),a=o.find("[title]").attr("title"),a||(a=o[0].textContent),a&&(a=a.replace(/\s+/g,""),i=PREF.getPref(e,a,"tool"),i&&"all"!==i[0]&&(o.addClass("page_toggle"),"none"!==i[0]&&i.forEach(t)))}function o(t){var n,o,a=t.canvasNode[0],i=e(a,".page_buttons"),l=e(a,".button_area"),r=PREF.getPref(t,"pagecontrol"),d=PREF.getPref(t,"resetbutton"),u=PREF.getPref(t,"wsplogo");1===i.length&&r&&(t.docSpec.pages.length<2?(i.removeClass("page_buttonsActive"),i.empty()):(n='<span class="page_btn page_prevBtn">&nbsp;</span><div style="display:inline-block; position:relative;"><span class="page_num"></span></div><span class="page_btn page_nextBtn">&nbsp;</span></span>',i.html(n),i.addClass("page_buttonsActive"),i.find(".page_num").on("click",{node:a},function(e){return c(e.data.node),!1}),i.find(".page_prevBtn").on("click",{node:a},function(e){return s(e.data.node,-1,!0),!1}),i.find(".page_nextBtn").on("click",{node:a},function(e){return s(e.data.node,1,!0),!1}),s(a,+t.metadata["start-page"]))),1===l.length&&(d.length&&"none"!==d[0]&&0===e(a,".reset_button").length&&(n='<button class="reset_button',"all"!==d[0]&&(n+=" page_toggle",d.forEach(function(e){n+=" p_"+e})),n+='" onclick="PAGENUM.resetPage(this);">Reset</button>',l.append(n)),u&&0===e(a,".wsp_logo").length&&(n='<div class="wsp_logo"></div>',o=l.find(".util-menu-btn"),o.length>0?o.after(n):l.prepend(n)))}function a(e){var t=e.focusPage.metadata.id,n=$(e.canvasNode).parent().find(".page_popupNum");n.length>0&&($(n).css("background-color","#fff"),$(n[t-1]).css("background-color","#ccc"))}function i(e,t){var n=$(e).closest(".sketch_container").find(".page_toggle");n.length&&(n.hide(),n.filter(".p_"+t).show())}function l(e,t){var n=e.focusPage,o=n.metadata.id,l=e.docSpec.pages.length,r=$(e.canvasNode).parent().find(".page_buttons");u&&n.restoreTraces(),r&&(r.find(".page_num").html("&nbsp;"+o+"&nbsp;"),r.find(".page_nextBtn").css("opacity",l>o?"1":"0.4"),r.find(".page_prevBtn").css("opacity",o>1?"1":"0.4"),a(e)),i(t,o)}function r(){var e=$(".sketch_canvas");e.on("LoadDocument.WSP",function(e,t){o(t.document),n(t.document)}),e.on("DidChangeCurrentPage.WSP",function(e,t){l(t.document,e.target)})}function s(e,n,o){var a=t(e),i=a.focusPage,l=+a.focusPage.metadata.id;o&&(n+=l),n>0&&n<=a.docSpec.pages.length&&n!==l&&(u&&!i.preferences.fadeTraces&&i.saveTraces(),a.switchPage(n))}function c(n){function o(e){return'<span class="page_popupNum">&nbsp;'+e+"&nbsp;</span>"}var i=e(n,".page_buttons");if(i.find(".page_popup").length>0)return void d(n);for(var l=t(n),r=l.docSpec.pages.length,c=o(1),u=2;r>=u;u+=1)c+="<br>"+o(u);var f=$.parseHTML('<div class="page_popup" style="line-height:1.1rem;">'+c+"</div>");i.find(".page_num").after(f[0]);var p=$(f).outerHeight()+1;$(f).css({top:-p+"px"}),a(l),i.find(".page_popupNum").on("mouseover",{node:n},function(e){s(e.data.node,this.innerText.trim())}),i.find(".page_popupNum").on("click",{node:n},function(e){return s(e.data.node,this.innerText.trim()),d(e.data.node),!1}),$(window).one("click",{node:n},function(e){return $(e.target).hasClass("page_num")?void 0:(d(e.data.node),!1)}),$(window).off("keydown"),$(window).on("keydown",{node:n},function(e){var t=e.which;return t>=37&&40>=t?(38>=t?s(e.data.node,-1,!0):s(e.data.node,1,!0),!1):void 0})}function d(t){var n=e(t,".page_buttons");n.find(".page_popupNum").off("mouseover"),n.find(".page_popupNum").off("click"),n.find(".page_popup").remove(),$(window).off("keydown")}var u=!0;return{initPageControls:function(){r()},resetPage:function(e){var n=WIDGETS.relatedSketchNode(e,".sketch_canvas");t(n).resetActivePage()}}}(),UTILMENU=function(){function e(e){function t(e){r.find(e).show(),c++}var n,o,a,i=PREF.getPref(e,"upload","util"),l=PREF.getPref(e,"download","util"),r=$(e.canvasNode).parent().find(".util-menu-btn"),s=i||l,c=0;s?(r.show(),$(r.find(".util-menu-item")).hide(),i&&t(".util-upload"),l&&t(".util-download"),n=r.find(".util-menu-content"),o=.25+1.45*c,a=-o-.4,n.css("height",o+"rem"),n.css("top",a+"rem")):r.hide()}function t(){$(".util-menu-content").hide(),$(window).off("click",n)}function n(e){return $(e.target).hasClass("util-menu")?void 0:(t(),!1)}function o(e,t){var n,o,a,i=e.pageData;if($("#util-fname")[0].validity.valid){".json"!==t.slice(-5)&&(t+=".json");var l=$("#downloadLink")[0];$.each(e.docSpec.pages,function(e,t){var n=t.metadata.id;i[n].session.traceData&&(t.traceData=i[n].session.traceData)}),n=e.sQuery().getSketchJSON(),o=new Blob([n],{type:"text/plain"}),a=URL.createObjectURL(o),l.href=a,l.download=t,l.click(),s(e),UTILMENU.closeModal("download-modal","save")}}function a(){var e=$("#download-modal");e.css("display","block"),e.find(".util-popup-content").tinyDraggable({exclude:".dragExclude"}),$("#util-fname").select()}function i(){t(),$("#upload-modal").data("sketchNode",u),$("#file-name-input").attr("onchange","UTILMENU.loadSketch(this.files[0]);")}function l(){function e(){o($(u).data("document"),$("#util-fname")[0].value)}t(),$("#download-modal").data("sketchNode",u);var n=$("#downloadOK");n.focus(),n.on("click",function(){e()}),$("#util-fname").on("keyup",function(t){var n=$("#util-fname")[0].validity.valid;27===t.keyCode?UTILMENU.closeModal("download-modal","cancel"):13===t.keyCode&&n&&e()})}function r(e){var t,n=$("#upload-modal");u=e,t=c(e)&&PREF.shouldEnableForCurrentPage("util","download",$(e).data("document").focusPage),i(),t?(l(),n.css("display","block"),n.find(".util-popup-content").tinyDraggable({exclude:".dragExclude"}),$("#downloadBeforeUpload").focus(),n.on("keyup",function(e){27===e.keyCode&&UTILMENU.closeModal("upload-modal","cancel")})):$("#file-name-input").click()}function s(e){var t=e.canvasNode[0].id,n=b64_md5(JSON.stringify(e.getCurrentSpecObject()));$("#"+t).data("prevChecksum",n)}function c(e){var t=$(e).data("document"),n=t.getCurrentSpecObject(),o=b64_md5(JSON.stringify(n)),a=$(e).data("prevChecksum");return o!==a}function d(e){function t(e){return e&&e.includes("Times")&&e.includes("sans-serif")&&(e=e.replace("sans-serif","serif")),e}function n(e){var n;for(n=0;n<e.length;++n)e[n]=t(e[n])}function o(e){$.each(e,function(e,n){var o=n["font-family"];o?n["font-family"]=t(o):n.label&&(o=n.label["font-family"],o&&(n.label["font-family"]=t(o)))})}function a(e){n(e.resources.fontList),e.pageData?$.each(e.pageData,function(e,t){o(t.spec.preferences.text.textTypes)}):$.each(e.pages,function(e,t){o(t.preferences.text.textTypes)})}var i=['"Times New Roman", serif','"Arial", sans-serif'];e.resources?e.resources.fontList?a(e):e.resources.fontList=i:e.resources={fontList:i},e.docSpec.resources?e.docSpec.resources.fontList?a(e.docSpec):e.docSpec.resources.fontList=i:e.docSpec.resources={fontList:i},o(e.focusPage.preferences.text.textTypes),s(e)}var u;return{checkFName:function(e){$("#downloadOK").prop("disabled",!e.valid)},closeModal:function(e,t){if($("#"+e).css("display","none"),"download-modal"===e)$("#util-fname").off("keyup"),$("#downloadOK").off("click");else if("upload-modal"===e)switch(t){case"save":a($(this).parents(".util-menu-btn"));break;case"dont-save":$("#file-name-input").click()}},download:function(e){u=WIDGETS.relatedSketchNode(e.target,".sketch_canvas"),$("#download-modal").data("callSave")&&$("#download-modal").removeData("callSave"),l(u),a()},loadSketch:function(e){var t=new FileReader,n=$(u);t.onload=function(t){n.data("sourceDocument",t.target.result),n.data("fileName",e.name.replace(".json","")),n.WSP("loadSketch"),n.removeData("sourceDocument")},t.readAsText(e)},upload:function(e){r(WIDGETS.relatedSketchNode(e.target,".sketch_canvas"))},menuBtnClicked:function(e){var t=$(e.parentNode).find(".util-menu-content");t.toggle(),"block"===t.css("display")&&$(window).on("click",n)},addUtilMenu:function(e){var t=WIDGETS.getScriptPath(),n='<div class="util-menu-btn util-menu">';return n+='<img class = "util-menu" src="'+t+'utility-icon.png" onclick="UTILMENU.menuBtnClicked(this);" />',n+='<div class="util-menu-content util-menu">',n+='<div class="util-menu-item util-menu util-download" onclick="UTILMENU.download(event)">Download...</div>',n+='<div class="util-menu-item util-menu util-upload" onclick="UTILMENU.upload(event);">Upload...</div>',n+="</div>",n+="</div>",e.replaceWith(n),n},initUtils:function(){var t=$(".sketch_canvas");t.on("LoadDocument.WSP",function(t,n){d(n.document),e(n.document)}),$.each(t,function(e,t){var n=$(t).parent(),o=n.find(".util-menu-btn"),a=$(t).data("document");1!==o.length||o[0].firstElementChild||UTILMENU.addUtilMenu(o),a&&d(a)})}}}();$(function(){WIDGETS.initWidget(),PAGENUM.initPageControls(),UTILMENU.initUtils()});